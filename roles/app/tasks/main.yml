---
- debug: var=app
- debug: var=user
- debug: var=opt

- name: dir_app
  command: "echo /opt/{{ app }}"
  register: dir_app

#- name: dir_app_etc
#  command: "echo {{ dir_app.stdout }}/etc"
#  register: dir_app_etc

#- name: dir_app_log
#  command: "echo {{ dir_app.stdout }}/log"
#  register: dir_app_log

- name: group
  group:
    name: "{{ user }}"
    state: present

- name: user
  user:
    name: "{{ user }}"
    group: "{{ user }}"
    shell: /bin/bash
    state: present

- name: app directory
  file:
    path: "{{ dir_app.stdout }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0700

# app/bin|etc|user_ssh|log
- name: app opt
  copy:
    src: "{{ opt }}/"
    dest: "{{ dir_app.stdout }}/"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0600

- name: app log
  file:
    path: "{{ dir_app.stdout }}/log"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0700

- name: chmod app
  file:
    path: "{{ dir_app.stdout }}"
    state: directory
    mode: u+rwX,go-rwx
    recurse: true

- name: chmod app/bin
  file:
    path: "{{ dir_app.stdout }}/bin"
    state: directory
    mode: u+rwx,go-rwx
    recurse: true

- name: link ~user/.ssh to /opt/app/user_ssh
  file:
    src: "{{ dir_app.stdout }}/user_ssh"
    dest: "~{{ user }}/.ssh"
    owner: "{{ user }}"
    group: "{{ user }}"
    state: link
